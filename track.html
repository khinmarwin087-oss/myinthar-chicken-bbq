<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Order</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #D4AF37; --navy: #0F172A; --pearl: #F8FAFC; }
        body { font-family: 'Inter', sans-serif; background: var(--pearl); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 400px; }
        .history-list { margin-bottom: 20px; }
        .order-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 1px solid #ddd; display: flex; justify-content: space-between; }
        .order-card.active { border: 2px solid var(--gold); background: #fffdf5; }
        
        #status-panel { display: none; background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-top: 5px solid var(--gold); }
        .status-box { background: var(--gold); color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 13px; }
        .info-group { background: #f8fafc; padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 14px; }
        .btn-home { width: 100%; background: var(--navy); color: var(--gold); border: none; padding: 15px; border-radius: 12px; font-weight: bold; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h3 style="color:var(--navy);"><i class="fas fa-history"></i> မှာယူမှုမှတ်တမ်း</h3>
    <div id="order-list" class="history-list"></div>

    <div id="status-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b id="display-id" style="font-size:18px;">#ID</b>
            <span id="display-status" class="status-box">စစ်ဆေးနေဆဲ...</span>
        </div>
        
        <div class="info-group">
            <b>မှာယူထားသောပစ္စည်းများ:</b><br>
            <span id="display-items">...</span>
        </div>
        
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span>စုစုပေါင်းကျသင့်ငွေ:</span>
            <span><span id="display-total">0</span> K</span>
        </div>
        
        <button class="btn-home" onclick="location.href='index.html'">မီနူးသို့ပြန်သွားမည်</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbywjHKV0aed5dV41xkLi_sZOOkXSzpkL6PAqJbMc1OR_JgQOmCyqIr_yE6C9eD2G4zy/exec";

    function init() {
        const orders = JSON.parse(localStorage.getItem('myOrders') || "[]").reverse();
        const listDiv = document.getElementById('order-list');
        
        if(orders.length === 0) {
            listDiv.innerHTML = "<p style='text-align:center;color:grey;'>မှတ်တမ်းမရှိသေးပါ</p>";
            return;
        }

        listDiv.innerHTML = orders.map(id => `
            <div class="order-card" id="card-${id}" onclick="getDetails('${id}')">
                <b>#${id}</b>
                <span style="color:var(--gold); font-size:12px;">အခြေအနေကြည့်ရန် ></span>
            </div>
        `).join('');

        // URL က ID ကို အော်တိုဖတ်မယ်
        const urlParams = new URLSearchParams(window.location.search);
        const idFromUrl = urlParams.get('id');
        if(idFromUrl) getDetails(idFromUrl);
    }

    async function getDetails(id) {
        // UI ပြောင်းလဲခြင်း
        document.querySelectorAll('.order-card').forEach(c => c.classList.remove('active'));
        if(document.getElementById(`card-${id}`)) document.getElementById(`card-${id}`).classList.add('active');
        
        document.getElementById('status-panel').style.display = 'block';
        document.getElementById('display-id').innerText = "#" + id;
        document.getElementById('display-status').innerText = "စစ်ဆေးနေဆဲ...";
        document.getElementById('display-items').innerText = "ဒေတာဆွဲယူနေသည်...";

        try {
            // Google Sheet ကနေ ဒေတာလှမ်းတောင်းတယ်
            const response = await fetch(SCRIPT_URL + "?id=" + id);
            const data = await response.json();
            
            if(data.status === "Not Found") {
                document.getElementById('display-status').innerText = "မတွေ့ပါ";
                document.getElementById('display-items').innerText = "Sheet ထဲမှာ ဒေတာရှာမတွေ့သေးပါ။";
            } else {
                document.getElementById('display-status').innerText = translateStatus(data.status);
                document.getElementById('display-items').innerText = data.items || "-";
                // Total ကို ဂဏန်းသက်သက်ပြောင်းမယ်
                let cleanTotal = String(data.total).replace(/[^0-9]/g, "");
                document.getElementById('display-total').innerText = Number(cleanTotal).toLocaleString();
            }
        } catch(e) {
            document.getElementById('display-status').innerText = "Error";
            document.getElementById('display-items').innerText = "Connection လွဲချော်နေပါသည်။";
        }
    }

    function translateStatus(s) {
        if(s === "Pending") return "လက်ခံရရှိ";
        if(s === "Accepted" || s === "Processing") return "ချက်ပြုတ်နေ";
        if(s === "Ready") return "လာယူနိုင်ပြီ";
        return s || "စောင့်ဆိုင်းဆဲ";
    }

    window.onload = init;
</script>
</body>
</html>
