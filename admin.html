<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pyidaungsu', sans-serif; background: #f3f4f6; }
        .order-new { background: #ffffff !important; border-left: 8px solid #ef4444 !important; font-weight: bold; }
        .order-read { background: #f9fafb !important; opacity: 0.8; border-left: 8px solid #cbd5e1 !important; }
        .new-badge { background: #ef4444; color: white; padding: 2px 10px; border-radius: 50px; font-size: 10px; font-weight: 900; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        th { background: #1e293b !important; color: white !important; font-size: 12px; padding: 15px !important; text-transform: uppercase; }
        #v-temp { position: fixed; left: -9999px; background: white; width: 350px; padding: 25px; }
    </style>
</head>
<body class="p-2 md:p-6">

    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6 bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-2xl font-black text-slate-800">MYIN THAR ROAST</h1>
                <p id="status-text" class="text-[10px] font-bold text-blue-500 uppercase">Connecting to Sheet...</p>
            </div>
            <button onclick="fetchAllData()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl text-[11px] font-black hover:bg-blue-700 shadow-lg active:scale-95">
                ðŸ”„ REFRESH NOW
            </button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-5 rounded-3xl border">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Total Orders</p>
                <h2 id="stat-orders" class="text-2xl font-black">0</h2>
            </div>
            <div class="bg-white p-5 rounded-3xl border border-b-4 border-b-blue-500">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Revenue</p>
                <h2 id="stat-revenue" class="text-2xl font-black">0 K</h2>
            </div>
            <div class="bg-white p-5 rounded-3xl border">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Customers</p>
                <h2 id="stat-users" class="text-2xl font-black">0</h2>
            </div>
            <div class="bg-white p-5 rounded-3xl border border-b-4 border-b-red-500">
                <p class="text-[10px] font-bold text-red-500 uppercase">Unread</p>
                <h2 id="stat-new" class="text-2xl font-black text-red-500">0</h2>
            </div>
        </div>

        <div class="mb-6">
            <input type="text" id="searchInput" oninput="searchOrders()" placeholder="á€”á€¬á€™á€Šá€ºáŠ á€–á€¯á€”á€ºá€¸ á€žá€­á€¯á€·á€™á€Ÿá€¯á€á€º á€•á€…á€¹á€…á€Šá€ºá€¸á€–á€¼á€„á€·á€º á€›á€¾á€¬á€›á€”á€º..." 
                   class="w-full p-4 bg-white border border-slate-200 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 80px;">Status</th>
                            <th>Customer</th>
                            <th>Order Details (Items)</th>
                            <th>Total Amount</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="order-body" class="divide-y divide-slate-100">
                        <tr><td colspan="5" class="p-10 text-center text-slate-400">Loading data... Please wait.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="v-temp">
        <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:15px; margin-bottom:15px;">
            <h2 style="margin:0; font-size:22px; font-weight:900;">MYIN THAR ROAST</h2>
            <p style="margin:5px 0 0 0; font-size:12px;">ORDER CONFIRMATION</p>
        </div>
        <div id="v-items" style="margin:20px 0; font-size:15px; line-height:1.6;"></div>
        <div style="text-align:right; font-size:20px; font-weight:900; border-top:3px solid #000; padding-top:10px;">
            TOTAL: <span id="v-total"></span> K
        </div>
    </div>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFy4xiu08UDQSBiTpo4DTH2XFbSAsCacSdv_ZtLtV93zNHWEPwkH2CKZqYmu3g2YIu/exec";
        let allData = [];
        let readOrders = JSON.parse(localStorage.getItem('readOrders') || '[]');

        async function fetchAllData() {
            const statusLabel = document.getElementById('status-text');
            try {
                statusLabel.innerText = "Connecting...";
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();

                if (allData.length > 0 && data.length > allData.length) {
                    document.getElementById('notif-sound').play().catch(e => {});
                }

                allData = data;
                updateStats(allData);
                renderTable(allData);
                statusLabel.innerText = "Sync Success: " + new Date().toLocaleTimeString();
            } catch (e) {
                statusLabel.innerText = "Sync Failed!";
                console.error(e);
            }
        }

        // á€‚á€á€”á€ºá€¸á€™á€Ÿá€¯á€á€ºá€á€¬á€•á€«á€›á€„á€º á€‚á€á€”á€ºá€¸á€•á€²á€•á€¼á€±á€¬á€„á€ºá€¸á€á€²á€· function
        function cleanPrice(val) {
            if (!val) return 0;
            // ááˆ,á€á€á€ K á€‘á€²á€€á€”á€± ááˆá€á€á€ á€•á€²á€šá€°á€™á€šá€º
            let num = String(val).replace(/[^0-9]/g, "");
            return num ? parseInt(num) : 0;
        }

        function updateStats(data) {
            let rev = 0; let unread = 0; const users = new Set();
            data.forEach((o, index) => {
                rev += cleanPrice(o.total);
                if (o.phone) users.add(o.phone);
                // Row ID á€™á€•á€«á€á€±á€¬á€·á€á€²á€·á€¡á€á€½á€€á€º index á€€á€­á€¯á€žá€¯á€¶á€¸á€•á€¼á€®á€¸ read/unread á€™á€¾á€á€ºá€™á€šá€º
                if (!readOrders.includes("id_"+index)) unread++;
            });
            document.getElementById('stat-orders').innerText = data.length;
            document.getElementById('stat-revenue').innerText = rev.toLocaleString() + " K";
            document.getElementById('stat-users').innerText = users.size;
            document.getElementById('stat-new').innerText = unread;
        }

        function markAsRead(uniqueId) {
            if (!readOrders.includes(uniqueId)) {
                readOrders.push(uniqueId);
                localStorage.setItem('readOrders', JSON.stringify(readOrders));
                renderTable(allData);
                updateStats(allData);
            }
        }

        function renderTable(data) {
            const body = document.getElementById('order-body');
            // á€¡á€±á€¬á€ºá€’á€«á€¡á€žá€…á€ºá€á€½á€±á€€á€­á€¯ á€¡á€•á€±á€«á€ºá€á€„á€ºá€™á€šá€º
            body.innerHTML = [...data].map((o, idx) => ({...o, originalIdx: idx})).reverse().map(o => {
                const uniqueId = "id_" + o.originalIdx;
                const isRead = readOrders.includes(uniqueId);
                const price = cleanPrice(o.total);

                return `
                    <tr class="transition cursor-pointer border-b ${isRead ? 'order-read' : 'order-new'}" onclick="markAsRead('${uniqueId}')">
                        <td class="p-5 text-center">${isRead ? '' : '<span class="new-badge">NEW</span>'}</td>
                        <td class="p-5">
                            <div class="font-bold text-slate-800">${o.name || 'No Name'}</div>
                            <div class="text-blue-500 text-[10px] font-bold">${o.phone || '-'}</div>
                        </td>
                        <td class="p-5 text-sm text-slate-600">${o.items || '-'}</td>
                        <td class="p-5 font-black text-slate-900">${price.toLocaleString()} K</td>
                        <td class="p-5 text-center">
                            <button onclick="event.stopPropagation(); markAsRead('${uniqueId}'); printVoucher('${o.name}','${o.items}','${price}')" 
                                    class="bg-slate-900 text-white px-5 py-2 rounded-xl text-[10px] font-black hover:bg-blue-600 transition">
                                VOUCHER
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function searchOrders() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(o => 
                (o.name && o.name.toLowerCase().includes(term)) || 
                (o.phone && o.phone.includes(term)) || 
                (o.items && o.items.toLowerCase().includes(term))
            );
            renderTable(filtered);
        }

        async function printVoucher(n, i, t) {
            document.getElementById('v-items').innerHTML = `<b>Name:</b> ${n}<br><br>${i.split(',').join('<br>')}`;
            document.getElementById('v-total').innerText = Number(t).toLocaleString();
            const canvas = await html2canvas(document.querySelector("#v-temp"), { scale: 3 });
            const link = document.createElement("a");
            link.download = `Voucher_${n}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        window.onload = fetchAllData;
        setInterval(fetchAllData, 120000);
    </script>
</body>
</html>
