<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clean Premium Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', 'Pyidaungsu', sans-serif; background: #fcfcfc; color: #1a1a1a; -webkit-tap-highlight-color: transparent; }
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-card { background: #fff; padding: 12px; border-radius: 16px; border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        
        /* Fixed Search Bar */
        #searchInput::placeholder { color: #94a3b8; font-size: 13px; }

        /* Clean White Popup */
        #details-modal { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.2); 
            backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-container { 
            background: #fff; width: 100%; max-width: 340px; border-radius: 24px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1); overflow: hidden;
            animation: zoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Voucher Template */
        #v-temp { position: fixed; left: -9999px; background: #fff; width: 320px; padding: 20px; color: #000; }
        .v-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 13px; }
        .v-table th { border-bottom: 1px solid #000; text-align: left; padding: 6px 0; }
        .v-table td { border-bottom: 1px solid #eee; padding: 8px 0; }
    </style>
</head>
<body>

    <div class="max-w-md mx-auto px-5 pb-20">
        <header class="py-6 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900">MYIN THAR ROAST</h1>
                <p id="status-text" class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest">Active Now</p>
            </div>
            <button onclick="fetchAllData()" class="p-2.5 bg-slate-50 rounded-full border border-slate-100 active:scale-90 transition">
                <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            </button>
        </header>

        <div class="stat-grid mb-6">
            <div class="stat-card">
                <span class="text-[9px] font-bold text-slate-400 uppercase">Revenue</span>
                <h2 id="stat-revenue" class="text-[15px] font-bold text-slate-800">0 K</h2>
            </div>
            <div class="stat-card border-r-4 border-r-rose-400">
                <span class="text-[9px] font-bold text-slate-400 uppercase">Unread</span>
                <h2 id="stat-new" class="text-[15px] font-bold text-rose-500">0</h2>
            </div>
            <div class="stat-card">
                <span class="text-[9px] font-bold text-slate-400 uppercase">Orders</span>
                <h2 id="stat-orders" class="text-[15px] font-bold text-slate-800">0</h2>
            </div>
            <div class="stat-card">
                <span class="text-[9px] font-bold text-slate-400 uppercase">Clients</span>
                <h2 id="stat-users" class="text-[15px] font-bold text-slate-800">0</h2>
            </div>
        </div>

        <div class="relative mb-6">
            <input type="text" id="searchInput" oninput="searchOrders()" placeholder="နာမည် (သို့) ဖုန်းဖြင့် ရှာဖွေပါ..." 
                   class="w-full h-11 bg-white border border-slate-200 rounded-12px px-4 text-sm focus:border-slate-400 outline-none transition-all shadow-sm">
        </div>

        <div id="order-list" class="space-y-3">
            <div class="text-center py-20 text-slate-300 text-sm">Loading Data...</div>
        </div>
    </div>

    <div id="details-modal" onclick="closeModal()">
        <div class="modal-container" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between p-4 border-b border-slate-50">
                <button onclick="closeModal()" class="flex items-center text-slate-400 text-xs font-bold">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                    BACK
                </button>
                <span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest">Order Info</span>
                <div class="w-10"></div>
            </div>

            <div id="modal-body" class="p-6 space-y-5">
                </div>

            <div class="p-4 bg-slate-50 flex gap-3">
                <button id="print-btn" class="flex-1 bg-slate-900 text-white h-12 rounded-16px text-xs font-bold shadow-lg active:scale-95 transition">
                    DOWNLOAD VOUCHER
                </button>
            </div>
        </div>
    </div>

    <div id="v-temp">
        <h2 style="text-align:center; font-size:22px; margin:0;">MYIN THAR ROAST</h2>
        <p style="text-align:center; font-size:11px; margin-bottom:15px; border-bottom:1px solid #000; padding-bottom:10px;">RECEIPT</p>
        <div id="v-info" style="font-size:13px;"></div>
        <table class="v-table"><tbody id="v-rows"></tbody></table>
        <div style="text-align:right; border-top:1px solid #000; padding-top:10px;">
            <p style="margin:0; font-size:11px;">Total Amount:</p>
            <h2 id="v-total" style="margin:0; font-size:24px; font-weight:900;"></h2>
        </div>
    </div>

    <audio id="click-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7X7KGkDqWouCZclxKjcNHUKFSRtJuymQK5x6JAgKIKzLlIddlcAUpKrirLH_dyh08nA/exec";
        let allData = [];
        let readOrders = JSON.parse(localStorage.getItem('readOrders') || '[]');

        function play(id) { document.getElementById(id).currentTime=0; document.getElementById(id).play().catch(()=>{}); }

        async function fetchAllData() {
            try {
                const res = await fetch(SCRIPT_URL);
                allData = await res.json();
                updateStats();
                renderItems(allData);
            } catch (e) { document.getElementById('status-text').innerText = "Sync Error"; }
        }

        function updateStats() {
            let rev = 0, unread = 0, users = new Set();
            allData.forEach((o, i) => {
                rev += parseInt(String(o.total || "").replace(/[^0-9]/g, "") || 0);
                if(o.phone) users.add(o.phone);
                if(!readOrders.includes("row_"+i)) unread++;
            });
            document.getElementById('stat-revenue').innerText = (rev/1000).toFixed(1) + " K";
            document.getElementById('stat-new').innerText = unread;
            document.getElementById('stat-orders').innerText = allData.length;
            document.getElementById('stat-users').innerText = users.size;
        }

        function renderItems(data) {
            const list = document.getElementById('order-list');
            list.innerHTML = data.map((o, i) => ({...o, originalIdx: i})).reverse().map(o => {
                const isRead = readOrders.includes("row_"+o.originalIdx);
                return `
                    <div class="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-100 shadow-sm active:bg-slate-50 transition" onclick="showDetails(${o.originalIdx})">
                        <div class="flex items-center gap-3">
                            <div class="w-1.5 h-10 ${isRead ? 'bg-slate-100' : 'bg-indigo-500'} rounded-full"></div>
                            <div>
                                <h4 class="font-bold text-sm text-slate-800">${o.name}</h4>
                                <p class="text-[11px] text-slate-400 font-medium">${o.phone || '-'}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-slate-900">${o.total} K</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Search Bar Fixed Logic
        function searchOrders() {
            const term = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!term) {
                renderItems(allData);
                return;
            }
            const filtered = allData.filter(o => 
                (o.name && o.name.toLowerCase().includes(term)) || 
                (o.phone && o.phone.includes(term))
            );
            renderItems(filtered);
        }

        function showDetails(idx) {
            play('click-sound');
            const o = allData[idx];
            if(!readOrders.includes("row_"+idx)) {
                readOrders.push("row_"+idx);
                localStorage.setItem('readOrders', JSON.stringify(readOrders));
                updateStats(); renderItems(allData);
            }

            document.getElementById('modal-body').innerHTML = `
                <div>
                    <h2 class="text-lg font-bold text-slate-800">${o.name}</h2>
                    <p class="text-xs text-slate-400 font-medium mb-4">${o.phone || '-'}</p>
                    
                    <div class="space-y-3">
                        <p class="text-[10px] font-bold text-slate-300 uppercase tracking-widest">Order Details</p>
                        <p class="text-sm text-slate-600 font-bold leading-relaxed">${(o.items || "").split(',').join('<br>')}</p>
                    </div>

                    <div class="mt-8 flex justify-between items-end border-t border-slate-50 pt-4">
                        <span class="text-xs text-slate-400 font-medium">Total Payable</span>
                        <span class="text-xl font-bold text-slate-900">${o.total} K</span>
                    </div>
                </div>
            `;
            document.getElementById('print-btn').onclick = () => printVoucher(o);
            document.getElementById('details-modal').style.display = 'flex';
        }

        function closeModal() {
            play('click-sound');
            document.getElementById('details-modal').style.display = 'none';
        }

        async function printVoucher(obj) {
            document.getElementById('v-info').innerHTML = `<b>Client:</b> ${obj.name}<br><b>Phone:</b> ${obj.phone || '-'}<br><b>Date:</b> ${obj.date || '-'}`;
            const items = (obj.items || "").split(',');
            document.getElementById('v-rows').innerHTML = items.map(item => {
                let name = item.split('(')[0].trim();
                let detail = item.includes('(') ? item.split('(')[1].replace(')', '') : "-";
                return `<tr><td>${name}</td><td style="text-align:right">${detail}</td></tr>`;
            }).join('');
            document.getElementById('v-total').innerText = obj.total + " K";

            const canvas = await html2canvas(document.querySelector("#v-temp"), { scale: 3 });
            const link = document.createElement("a");
            link.download = `Voucher_${obj.name}.png`;
            link.href = canvas.toDataURL(); link.click();
        }

        window.onload = fetchAllData;
        setInterval(fetchAllData, 60000);
    </script>
</body>
</html>
