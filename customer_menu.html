<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YNS Kitchen - Menu</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --pearl: #ffffff; --bg: #F8F9FC; --primary: #007AFF; --text: #1C1C1E; --gray: #8E8E93; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; }

        /* Header & Search */
        .header { background: var(--pearl); padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .top-nav { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; justify-content: space-between; }
        .nav-left { display: flex; align-items: center; gap: 10px; }
        .back-link { text-decoration: none; color: var(--text); font-size: 18px; }
        .search-box { background: #F2F2F7; border-radius: 12px; padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        .search-box input { border: none; background: none; outline: none; width: 100%; font-size: 14px; }

        /* Login Modal CSS */
        .login-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end; justify-content: center; }
        .login-card { background: white; width: 100%; border-radius: 30px 30px 0 0; padding: 30px 25px; text-align: center; animation: slideUp 0.3s ease-out; box-sizing: border-box; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .g-btn { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; height: 50px; background: white; border: 1px solid #747775; border-radius: 25px; font-weight: 600; cursor: pointer; margin: 20px 0 10px; font-family: inherit; }

        /* Categories */
        .categories { padding: 10px 15px; display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .cat-item { background: white; padding: 8px 18px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; }
        .cat-item.active { background: var(--primary); color: white; }

        /* Menu Display */
        .menu-container { padding: 10px 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .food-card { background: white; border-radius: 20px; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .food-img { width: 100%; height: 110px; border-radius: 15px; object-fit: cover; }
        .food-name { font-weight: 700; font-size: 14px; margin: 8px 0 4px; display: block; height: 35px; overflow: hidden; }
        .food-price { color: var(--primary); font-weight: 800; font-size: 13px; display: block; margin-bottom: 10px; }
        .add-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 10px; border-radius: 12px; font-weight: 700; cursor: pointer; }

        /* Floating Cart Bar */
        .cart-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: var(--text); color: white; padding: 15px 20px; border-radius: 22px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; z-index: 500; }

        /* Cart Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-radius: 30px 30px 0 0; padding: 25px; max-height: 90vh; overflow-y: auto; box-sizing: border-box; }
        
        .cart-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #F2F2F7; }
        .cart-img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; }
        .cart-info { flex: 1; }
        .cart-name { font-weight: 700; font-size: 14px; display: block; }
        .cart-price { color: var(--primary); font-weight: 700; font-size: 12px; }
        .cart-qty-ctrl { display: flex; align-items: center; gap: 8px; background: #F2F2F7; padding: 5px; border-radius: 10px; }
        .qty-btn { border: none; background: white; width: 24px; height: 24px; border-radius: 6px; font-weight: 800; color: var(--primary); cursor: pointer; }
        .qty-input { width: 40px; border: none; background: transparent; text-align: center; font-weight: 700; font-size: 14px; outline: none; }
        .del-item { color: #FF3B30; font-size: 18px; margin-left: 5px; cursor: pointer; }

        /* Form */
        .form-group { margin-top: 20px; }
        .input-box { margin-bottom: 12px; }
        .input-box label { font-size: 11px; font-weight: 800; color: var(--gray); display: block; margin-bottom: 5px; }
        .input-box input, .input-box textarea { width: 100%; padding: 12px; border: 1px solid #E5E5EA; border-radius: 12px; font-family: inherit; box-sizing: border-box; outline: none; }
        .submit-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 16px; border-radius: 15px; font-weight: 800; font-size: 16px; margin-top: 20px; cursor: pointer; }

        /* Full Screen Voucher View */
        #voucher-overlay { 
            position: fixed; inset: 0; background: #f0f2f5; z-index: 3000; 
            display: none; flex-direction: column; align-items: center; 
            padding: 20px; overflow-y: auto;
        }
        #voucher-card { 
            background: white; width: 100%; max-width: 400px; 
            border-radius: 28px; padding: 35px 25px; box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .v-header { text-align: center; margin-bottom: 25px; }
        .v-check { width: 50px; height: 50px; background: #E8F2FF; color: var(--primary); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 10px; }
        .v-info-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px 0; border-top: 1px solid #f2f2f2; margin-bottom: 20px; }
        .v-item { font-size: 12px; }
        .v-item label { color: var(--gray); font-weight: 700; font-size: 10px; display: block; margin-bottom: 3px; }
        .v-item span { font-weight: 600; color: var(--text); }
        .v-table { background: #fafafa; border-radius: 18px; padding: 15px; margin-bottom: 20px; }
        .v-row { display: grid; grid-template-columns: 2fr 1fr 1fr; font-size: 13px; padding: 8px 0; border-bottom: 1px solid #eee; }
        .v-row:last-child { border-bottom: none; }
        .v-total-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0 5px; font-weight: 800; border-top: 1px dashed #ddd; margin-top: 10px; }
        .v-btns { width: 100%; max-width: 400px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; padding-bottom: 30px; }
        .v-btn { padding: 16px; border-radius: 18px; border: none; font-weight: 700; cursor: pointer; text-align: center; }
    </style>
</head>
<body>

    <div id="voucher-overlay">
        <div id="voucher-card">
            <div class="v-header">
                <div class="v-check"><i class="fas fa-check"></i></div>
                <h2 style="margin:0;">Order Placed!</h2>
                <div id="v-id" style="color:var(--gray); font-size:12px; margin-top:5px;">ID: #----</div>
            </div>
            <div class="v-info-box">
                <div class="v-item"><label>CUSTOMER</label><span id="v-name">-</span></div>
                <div class="v-item" style="text-align:right;"><label>PHONE</label><span id="v-phone">-</span></div>
                <div class="v-item"><label>DATE</label><span id="v-date">-</span></div>
                <div class="v-item" style="text-align:right;"><label>TIME</label><span id="v-time">-</span></div>
            </div>
            <div class="v-table">
                <div class="v-row" style="color:var(--gray); font-weight:800; font-size:10px;">
                    <span>ITEM</span><span style="text-align:center;">QTY</span><span style="text-align:right;">PRICE</span>
                </div>
                <div id="v-list"></div>
                <div class="v-total-row">
                    <span>Total Amount</span>
                    <span id="v-total" style="color:var(--primary); font-size:22px;">0 Ks</span>
                </div>
            </div>
            <div style="text-align:center; color:#ccc; font-size:11px;">Thank you for your order!</div>
        </div>
        <div class="v-btns">
            <button class="v-btn" style="background:white; border:1px solid #eee;" onclick="location.reload()">Back Home</button>
            <button class="v-btn" style="background:var(--text); color:white;" onclick="saveVoucher()">Save PNG</button>
        </div>
    </div>

    <div id="login-modal" class="login-modal">
        <div class="login-card">
            <h3 style="margin:0;">Login ဝင်ရန်လိုအပ်ပါသည်</h3>
            <p style="color:var(--gray); font-size:14px;">ခြင်းတောင်းထဲထည့်ရန် Google Login အရင်ဝင်ပေးပါ</p>
            <button class="g-btn" onclick="startGoogleLogin()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_Color_Icon.svg" width="20"> Sign in with Google
            </button>
            <button onclick="document.getElementById('login-modal').style.display='none'" style="border:none; background:none; color:var(--gray); font-weight:700; cursor:pointer; margin-top:10px;">မဝင်သေးပါ</button>
        </div>
    </div>

    <div class="header">
        <div class="top-nav">
            <div class="nav-left">
                <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Dashboard</a>
            </div>
            <div id="user-profile"></div>
        </div>
        <div class="search-box">
            <i class="fas fa-search" style="color:var(--gray)"></i>
            <input type="text" id="search" placeholder="Search menu..." oninput="filterItems()">
        </div>
    </div>

    <div class="categories" id="cat-list"></div>
    <div class="menu-container" id="menu-display"></div>

    <div class="cart-bar" id="cart-bar">
        <div><b id="total-ks">0 Ks</b><br><span id="total-items" style="font-size:11px">0 Items</span></div>
        <button onclick="toggleModal(true)" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:12px; font-weight:700;">View Cart</button>
    </div>

    <div class="modal" id="cart-modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">Your Cart</h2>
                <i class="fas fa-times" onclick="toggleModal(false)" style="font-size:22px; color:var(--gray); cursor:pointer;"></i>
            </div>
            <div id="cart-items-list"></div>
            
            <div id="cart-total-display" style="display:flex; justify-content:space-between; padding: 15px 0; border-top: 1px solid #eee; margin-top:10px; font-weight:800;">
                <span>Total Amount:</span>
                <span id="modal-total-amt" style="color:var(--primary);">0 Ks</span>
            </div>

            <div class="form-group">
                <div class="input-box"><label>Name</label><input type="text" id="o-name" placeholder="သင့်နာမည်"></div>
                <div class="input-box"><label>Phone</label><input type="tel" id="o-phone" placeholder="09xxxxxxx"></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div class="input-box"><label>Date</label><input type="date" id="o-date"></div>
                    <div class="input-box"><label>Time</label><input type="time" id="o-time"></div>
                </div>
                <div class="input-box"><label>Special Note</label><textarea id="o-note" rows="2" placeholder="အသားပို၊ အစပ်လျှော့..."></textarea></div>
                <button class="submit-btn" id="submit-btn" onclick="sendOrder()">Confirm Order</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB3SaXUOzDh9_DVbuupon7BsCgZfw5UzZ4",
            authDomain: "myrestaurantapp-a14d4.firebaseapp.com",
            databaseURL: "https://myrestaurantapp-a14d4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myrestaurantapp-a14d4",
            storageBucket: "myrestaurantapp-a14d4.firebasestorage.app",
            messagingSenderId: "123788707874",
            appId: "1:123788707874:web:6593b827b284cc7cb9a27b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        
        let menuData = [];
        let cart = {};
        let pendingItemId = null;

        auth.onAuthStateChanged(user => {
            const profileDiv = document.getElementById('user-profile');
            if (user) {
                profileDiv.innerHTML = `<img src="${user.photoURL}" style="width:30px; border-radius:50%; border:2px solid var(--primary);">`;
                document.getElementById('o-name').value = user.displayName;
                if (pendingItemId) {
                    addToCart(pendingItemId);
                    pendingItemId = null;
                }
            } else {
                profileDiv.innerHTML = `<i class="fas fa-user-circle" style="font-size:24px; color:var(--gray);"></i>`;
            }
        });

        async function startGoogleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
                document.getElementById('login-modal').style.display = 'none';
            } catch (e) { console.error(e); }
        }

        function init() {
            db.ref('menu').on('value', snap => {
                const data = snap.val();
                menuData = [];
                const cats = new Set(['All']);
                if(data) {
                    for(let id in data) {
                        menuData.push({...data[id], id});
                        if(data[id].category) cats.add(data[id].category);
                    }
                }
                renderCats(cats);
                renderMenu(menuData);
            });
        }

        function renderCats(cats) {
            const list = document.getElementById('cat-list');
            list.innerHTML = Array.from(cats).map(c => `<div class="cat-item ${c==='All'?'active':''}" onclick="filterCat('${c}', this)">${c}</div>`).join('');
        }

        function renderMenu(items) {
            const display = document.getElementById('menu-display');
            display.innerHTML = items.map(i => `
                <div class="food-card">
                    <img src="${i.image || 'https://via.placeholder.com/150'}" class="food-img">
                    <b class="food-name">${i.name}</b>
                    <span class="food-price">${parseInt(i.price).toLocaleString()} Ks</span>
                    <button class="add-btn" onclick="handleAddToCart('${i.id}')">Add to Cart</button>
                </div>
            `).join('');
        }

        function handleAddToCart(id) {
            if (auth.currentUser) {
                addToCart(id);
            } else {
                pendingItemId = id;
                document.getElementById('login-modal').style.display = 'flex';
            }
        }

        function addToCart(id) {
            const item = menuData.find(m => m.id === id);
            // ဈေးနှုန်းကို String ဖြစ်နေရင် ကိန်းဂဏန်းအဖြစ်ပြောင်းမယ်
            const cleanPrice = typeof item.price === 'string' ? parseInt(item.price.replace(/,/g, '')) : item.price;
            
            if(!cart[id]) cart[id] = { name: item.name, price: cleanPrice, image: item.image, qty: 1 };
            else cart[id].qty += 1;
            updateCartBar();
        }

        function updateQty(id, delta) {
            cart[id].qty += delta;
            if(cart[id].qty <= 0) delete cart[id];
            updateCartBar();
            renderCartList();
        }

        function manualQty(id, val) {
            let n = parseInt(val);
            if(isNaN(n) || n <= 0) delete cart[id];
            else cart[id].qty = n;
            updateCartBar();
            renderCartList();
        }

        function updateCartBar() {
            const bar = document.getElementById('cart-bar');
            const qty = Object.values(cart).reduce((s, i) => s + i.qty, 0);
            const amt = Object.values(cart).reduce((s, i) => s + (i.qty * i.price), 0);
            
            if(qty > 0) {
                bar.style.display = 'flex';
                document.getElementById('total-ks').innerText = amt.toLocaleString() + " Ks";
                document.getElementById('total-items').innerText = qty + " items";
                // Modal ထဲက Total ကိုပါ update လုပ်မယ်
                const modalTotal = document.getElementById('modal-total-amt');
                if(modalTotal) modalTotal.innerText = amt.toLocaleString() + " Ks";
            } else {
                bar.style.display = 'none';
                toggleModal(false);
            }
        }

        function renderCartList() {
            const container = document.getElementById('cart-items-list');
            let html = "";
            for(let id in cart) {
                const item = cart[id];
                html += `
                <div class="cart-item">
                    <img src="${item.image || 'https://via.placeholder.com/50'}" class="cart-img">
                    <div class="cart-info"><span class="cart-name">${item.name}</span><span class="cart-price">${(item.qty * item.price).toLocaleString()} Ks</span></div>
                    <div class="cart-qty-ctrl">
                        <button class="qty-btn" onclick="updateQty('${id}', -1)">-</button>
                        <input type="number" class="qty-input" value="${item.qty}" onchange="manualQty('${id}', this.value)">
                        <button class="qty-btn" onclick="updateQty('${id}', 1)">+</button>
                    </div>
                    <i class="fas fa-trash del-item" onclick="delete cart['${id}']; updateCartBar(); renderCartList();"></i>
                </div>`;
            }
            container.innerHTML = html;
        }

        function toggleModal(show) {
            document.getElementById('cart-modal').style.display = show ? 'flex' : 'none';
            if(show) {
                renderCartList();
                document.getElementById('o-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('o-time').value = new Date().toLocaleTimeString('en-GB',{hour:'2-digit', minute:'2-digit', hour12: true});
            }
        }

        function filterItems() {
            const val = document.getElementById('search').value.toLowerCase();
            renderMenu(menuData.filter(m => m.name.toLowerCase().includes(val)));
        }

        function filterCat(c, el) {
            document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            renderMenu(c === 'All' ? menuData : menuData.filter(m => m.category === c));
        }

        // ... (အရင် HTML/CSS တွေ အကုန်အတိုင်းပဲ ထားပါ) ...

function sendOrder() {
    const user = auth.currentUser;
    if (!user) { document.getElementById('login-modal').style.display = 'flex'; return; }

    const n = document.getElementById('o-name').value;
    const p = document.getElementById('o-phone').value;
    if(!n || !p || Object.keys(cart).length === 0) return alert("အချက်အလက် ပြည့်စုံစွာ ဖြည့်စွက်ပါ");

    const btn = document.getElementById('submit-btn');
    btn.innerText = "စစ်ဆေးနေပါသည်..."; btn.disabled = true;

    // --- အဆင့် (၁) STOCK ရှိမရှိ အရင်စစ်ဆေးမည့်အပိုင်း ---
    const checkStockPromises = Object.keys(cart).map(id => {
        return db.ref(`menu/${id}`).once('value').then(snap => {
            const itemData = snap.val();
            const currentStock = itemData.stock || 0;
            const orderQty = cart[id].qty;

            if (currentStock < orderQty) {
                // Stock မလုံလောက်ရင် Error ပေးမယ်
                throw new Error(`${itemData.name} သည် Stock မလုံလောက်ပါ။ (လက်ရှိ: ${currentStock})`);
            }
            return { id, newStock: currentStock - orderQty };
        });
    });

    // Stock အားလုံး စစ်ဆေးပြီးမှ အောက်က အဆင့်တွေကို ဆက်သွားမယ်
    Promise.all(checkStockPromises).then(results => {
        
        // --- အဆင့် (၂) Stock လုံလောက်မှသာ Stock များကို နှုတ်မယ် ---
        const updateStockPromises = results.map(res => {
            return db.ref(`menu/${res.id}/stock`).set(res.newStock);
        });

        return Promise.all(updateStockPromises);
        
    }).then(() => {
        // --- အဆင့် (၃) Stock နှုတ်ပြီးမှသာ အော်ဒါအမှန်တကယ် တင်မည် ---
        const orderId = "ORD" + Math.floor(1000 + Math.random() * 9000);
        const totalAmt = Object.values(cart).reduce((s, i) => s + (i.qty * i.price), 0);

        const orderData = {
            orderId: orderId,
            deviceUID: user.uid,
            customerName: n,
            customerPhone: p,
            date: document.getElementById('o-date').value,
            time: document.getElementById('o-time').value,
            note: document.getElementById('o-note').value,
            items: Object.values(cart),
            total: totalAmt,
            status: "Pending",
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        return db.ref('orders').push(orderData).then(() => {
            showVoucher(orderData);
            cart = {};
            updateCartBar();
            btn.innerText = "Confirm Order"; btn.disabled = false;
        });

    }).catch(err => {
        // Stock မလုံလောက်တာဖြစ်ဖြစ်၊ တခြား Error ဖြစ်ရင် ဒီကိုရောက်မယ်
        alert("⚠️ သတိပေးချက်: " + err.message);
        btn.innerText = "Confirm Order"; btn.disabled = false;
    });
}
        

// ... (ကျန်တဲ့ function တွေ အကုန်အတိုင်းပဲ ထားပါ) ...
        

            

        function showVoucher(data) {
            document.getElementById('cart-modal').style.display = 'none';
            document.getElementById('v-id').innerText = "ID: #" + data.orderId;
            document.getElementById('v-name').innerText = data.customerName;
            document.getElementById('v-phone').innerText = data.customerPhone;
            document.getElementById('v-date').innerText = data.date;
            document.getElementById('v-time').innerText = data.time;
            
            // Total ပေါ်လာဖို့ သေချာအောင် လုပ်ထားပါတယ်
            document.getElementById('v-total').innerText = (data.total || 0).toLocaleString() + " Ks";
            
            document.getElementById('v-list').innerHTML = data.items.map(i => {
                const itemTotal = i.qty * (typeof i.price === 'string' ? parseInt(i.price.replace(/,/g, '')) : i.price);
                return `
                <div class="v-row">
                    <span>${i.name}</span>
                    <span style="text-align:center; font-weight:700; color:var(--primary);">${i.qty}</span>
                    <span style="text-align:right; font-weight:700;">${itemTotal.toLocaleString()}</span>
                </div>
            `}).join('');

            document.getElementById('voucher-overlay').style.display = 'flex';
        }

        function saveVoucher() {
            const card = document.getElementById('voucher-card');
            html2canvas(card, { scale: 3, backgroundColor: "#ffffff" }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'YNS-Kitchen-Voucher-' + Date.now() + '.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        window.onload = init;
    </script>
</body>
</html>
