<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YNS Kitchen - Menu</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --pearl: #ffffff; --bg: #F8F9FC; --primary: #007AFF; --text: #1C1C1E; --gray: #8E8E93; --red: #FF3B30; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; overflow-x: hidden; }

        /* Toast Notification */
        #toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: #323232; color: white; padding: 14px 24px; border-radius: 16px;
            font-size: 14px; font-weight: 600; z-index: 9999; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #toast.show { top: 20px; }
        .toast-icon { color: var(--red); font-size: 18px; }

        /* Header */
        .header { background: var(--pearl); padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .top-nav { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; justify-content: space-between; }
        .search-box { background: #F2F2F7; border-radius: 12px; padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        .search-box input { border: none; background: none; outline: none; width: 100%; font-size: 14px; }

        /* Login Modal - á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€‘á€¬á€¸á€á€²á€· CSS */
        .login-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end; justify-content: center; }
        .login-card { background: white; width: 100%; border-radius: 30px 30px 0 0; padding: 30px 25px; text-align: center; animation: slideUp 0.3s ease-out; box-sizing: border-box; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .g-btn { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; height: 50px; background: white; border: 1px solid #747775; border-radius: 25px; font-weight: 600; cursor: pointer; margin: 20px 0 10px; }

        /* Menu */
        .categories { padding: 10px 15px; display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .cat-item { background: white; padding: 8px 18px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .cat-item.active { background: var(--primary); color: white; }
        .menu-container { padding: 10px 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .food-card { background: white; border-radius: 20px; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .food-img { width: 100%; height: 110px; border-radius: 15px; object-fit: cover; }
        .food-name { font-weight: 700; font-size: 14px; margin: 8px 0 4px; display: block; height: 35px; overflow: hidden; }
        .food-price { color: var(--primary); font-weight: 800; font-size: 13px; display: block; margin-bottom: 10px; }
        .add-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 10px; border-radius: 12px; font-weight: 700; cursor: pointer; }

        /* Cart & Modal */
        .cart-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: var(--text); color: white; padding: 15px 20px; border-radius: 22px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; z-index: 500; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-radius: 30px 30px 0 0; padding: 25px; max-height: 90vh; overflow-y: auto; box-sizing: border-box; }
        
        /* ... (á€€á€»á€”á€ºá€á€²á€· CSS á€á€½á€± á€¡á€€á€¯á€”á€ºá€›á€¾á€­á€”á€±á€•á€«á€á€šá€º) ... */
        .cart-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #F2F2F7; }
        .cart-img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; }
        .cart-info { flex: 1; }
        .cart-name { font-weight: 700; font-size: 14px; display: block; }
        .cart-price { color: var(--primary); font-weight: 700; font-size: 12px; }
        .cart-qty-ctrl { display: flex; align-items: center; gap: 8px; background: #F2F2F7; padding: 5px; border-radius: 10px; }
        .qty-btn { border: none; background: white; width: 24px; height: 24px; border-radius: 6px; font-weight: 800; color: var(--primary); cursor: pointer; }
        .qty-input { width: 40px; border: none; background: transparent; text-align: center; font-weight: 700; font-size: 14px; outline: none; }
        .del-item { color: var(--red); font-size: 18px; margin-left: 10px; cursor: pointer; padding: 5px; }
        .modal-total { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; margin-top: 10px; border-top: 2px dashed #F2F2F7; }
        .modal-total b { font-size: 18px; color: var(--primary); }
        .input-box { margin-bottom: 12px; }
        .input-box label { font-size: 11px; font-weight: 800; color: var(--gray); display: block; margin-bottom: 5px; }
        .input-box input, .input-box textarea { width: 100%; padding: 12px; border: 1px solid #E5E5EA; border-radius: 12px; font-family: inherit; box-sizing: border-box; outline: none; }
        .submit-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 16px; border-radius: 15px; font-weight: 800; font-size: 16px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="toast">
        <i class="fas fa-exclamation-circle toast-icon"></i>
        <span id="toast-msg">á€¡á€á€»á€€á€ºá€¡á€œá€€á€º á€•á€¼á€Šá€·á€ºá€…á€¯á€¶á€…á€½á€¬ á€–á€¼á€Šá€·á€ºá€•á€«</span>
    </div>

    <div id="login-modal" class="login-modal">
        <div class="login-card">
            <h3 style="margin:0;">Login á€á€„á€ºá€›á€”á€ºá€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€º</h3>
            <p style="color:var(--gray); font-size:14px;">á€¡á€±á€¬á€ºá€’á€«á€á€„á€ºá€›á€”á€º Google Login á€¡á€›á€„á€ºá€á€„á€ºá€•á€±á€¸á€•á€«</p>
            <button class="g-btn" onclick="startGoogleLogin()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_Color_Icon.svg" width="20"> Sign in with Google
            </button>
            <button onclick="document.getElementById('login-modal').style.display='none'" style="border:none; background:none; color:var(--gray); font-weight:700; cursor:pointer; margin-top:10px;">á€™á€á€„á€ºá€á€±á€¸á€•á€«</button>
        </div>
    </div>

    <div class="header">
        <div class="top-nav">
            <a href="index.html" style="text-decoration:none; color:var(--text);"><i class="fas fa-arrow-left"></i></a>
            <h2 style="margin:0; font-size: 20px;">YNS Kitchen</h2>
            <div id="user-profile"></div> 
        </div>
        <div class="search-box">
            <i class="fas fa-search" style="color:var(--gray)"></i>
            <input type="text" id="search" placeholder="á€Ÿá€„á€ºá€¸á€•á€½á€²á€›á€¾á€¬á€›á€”á€º..." oninput="filterItems()">
        </div>
    </div>

    <div class="categories" id="cat-list"></div>
    <div class="menu-container" id="menu-display"></div>

    <div class="cart-bar" id="cart-bar">
        <div><b id="total-ks">0 Ks</b><br><span id="total-items" style="font-size:11px">0 Items</span></div>
        <button onclick="toggleModal(true)" style="background:var(--primary); color:white; border:none; padding:10px 22px; border-radius:14px; font-weight:700;">á€á€¼á€„á€ºá€¸á€á€±á€¬á€„á€ºá€¸á€€á€¼á€Šá€·á€ºá€›á€”á€º</button>
    </div>

    <div class="modal" id="cart-modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">ğŸ›’ á€›á€½á€±á€¸á€á€»á€šá€ºá€‘á€¬á€¸á€á€Šá€ºá€™á€»á€¬á€¸</h2>
                <i class="fas fa-times" onclick="toggleModal(false)" style="font-size:22px; color:var(--gray); cursor:pointer;"></i>
            </div>
            
            <div id="cart-items-list"></div>

            <div class="modal-total">
                <span>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€€á€»á€á€„á€·á€ºá€„á€½á€±</span>
                <b id="modal-total-val">0 Ks</b>
            </div>

            <div class="form-group">
                <div class="input-box"><label>á€”á€¬á€™á€Šá€º</label><input type="text" id="o-name" placeholder="á€á€„á€·á€ºá€”á€¬á€™á€Šá€º á€–á€¼á€Šá€·á€ºá€•á€«"></div>
                <div class="input-box"><label>á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º</label><input type="tel" id="o-phone" placeholder="09xxxxxxx"></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div class="input-box"><label>á€›á€€á€ºá€…á€½á€²</label><input type="date" id="o-date"></div>
                    <div class="input-box"><label>á€¡á€á€»á€­á€”á€º</label><input type="time" id="o-time"></div>
                </div>
                <div class="input-box"><label>á€¡á€á€¼á€¬á€¸á€™á€¾á€á€ºá€á€»á€€á€º</label><textarea id="o-note" rows="2" placeholder="á€¡á€á€¬á€¸á€•á€­á€¯áŠ á€¡á€…á€•á€ºá€œá€»á€¾á€±á€¬á€·... á€…á€á€Šá€ºá€–á€¼á€„á€·á€º"></textarea></div>
                <button class="submit-btn" id="submit-btn" onclick="sendOrder()">á€¡á€±á€¬á€ºá€’á€«á€á€„á€ºá€™á€Šá€º</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB3SaXUOzDh9_DVbuupon7BsCgZfw5UzZ4",
            authDomain: "myrestaurantapp-a14d4.firebaseapp.com",
            databaseURL: "https://myrestaurantapp-a14d4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myrestaurantapp-a14d4",
            storageBucket: "myrestaurantapp-a14d4.firebasestorage.app",
            messagingSenderId: "123788707874",
            appId: "1:123788707874:web:6593b827b284cc7cb9a27b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let menuData = []; let cart = {};
        let pendingItemId = null; // Login á€™á€á€„á€ºá€á€„á€º á€”á€¾á€­á€•á€ºá€œá€­á€¯á€€á€ºá€á€²á€· ID á€€á€­á€¯ á€™á€¾á€á€ºá€‘á€¬á€¸á€–á€­á€¯á€·

        // Login á€¡á€á€¼á€±á€¡á€”á€±á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€á€¬ (á€¡á€á€…á€º)
        auth.onAuthStateChanged(user => {
            const profileDiv = document.getElementById('user-profile');
            if (user) {
                profileDiv.innerHTML = `<img src="${user.photoURL}" style="width:30px; border-radius:50%; border:1px solid #eee;">`;
                document.getElementById('o-name').value = user.displayName;
                if (pendingItemId) {
                    addToCart(pendingItemId);
                    pendingItemId = null;
                }
            } else {
                profileDiv.innerHTML = `<i class="fas fa-user-circle" style="font-size:24px; color:var(--gray);"></i>`;
            }
        });

        // Google Login á€á€„á€ºá€á€²á€· function (á€¡á€á€…á€º)
        async function startGoogleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
                document.getElementById('login-modal').style.display = 'none';
            } catch (e) {
                alert("Login Error: " + e.message);
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function init() {
            db.ref('menu').on('value', snap => {
                const data = snap.val(); menuData = []; const cats = new Set(['All']);
                if(data) {
                    for(let id in data) {
                        menuData.push({...data[id], id});
                        if(data[id].category) cats.add(data[id].category);
                    }
                }
                renderCats(cats); renderMenu(menuData);
            });
        }

        function renderCats(cats) {
            const list = document.getElementById('cat-list');
            list.innerHTML = Array.from(cats).map(c => `<div class="cat-item ${c==='All'?'active':''}" onclick="filterCat('${c}', this)">${c}</div>`).join('');
        }

        // Render Menu á€™á€¾á€¬ onclick á€€á€­á€¯ handleAddToCart á€œá€­á€¯á€· á€•á€¼á€±á€¬á€„á€ºá€¸á€‘á€¬á€¸á€•á€«á€á€šá€º
        function renderMenu(items) {
            const display = document.getElementById('menu-display');
            display.innerHTML = items.map(i => `
                <div class="food-card">
                    <img src="${i.image || 'https://via.placeholder.com/150'}" class="food-img">
                    <b class="food-name">${i.name}</b>
                    <span class="food-price">${parseInt(i.price).toLocaleString()} Ks</span>
                    <button class="add-btn" onclick="handleAddToCart('${i.id}')">á€‘á€Šá€·á€ºá€™á€Šá€º</button>
                </div>
            `).join('');
        }

        // Login á€›á€¾á€­á€™á€›á€¾á€­ á€¡á€›á€„á€ºá€…á€…á€ºá€á€²á€· function (á€¡á€á€…á€º)
        function handleAddToCart(id) {
            if (auth.currentUser) {
                addToCart(id);
            } else {
                pendingItemId = id;
                document.getElementById('login-modal').style.display = 'flex';
            }
        }

        // á€™á€°á€œ addToCart logic á€€á€­á€¯ á€˜á€¬á€™á€¾á€™á€–á€»á€€á€ºá€‘á€¬á€¸á€•á€«á€˜á€°á€¸
        function addToCart(id) {
            const item = menuData.find(m => m.id === id);
            if(!cart[id]) cart[id] = { name: item.name, price: item.price, image: item.image, qty: 1 };
            else cart[id].qty += 1;
            updateCartBar();
            showToast("á€á€¼á€„á€ºá€¸á€á€±á€¬á€„á€ºá€¸á€‘á€²á€‘á€Šá€·á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®");
        }

        // ... (á€€á€»á€”á€ºá€á€²á€· updateQty, manualQty, removeItem, updateCartBar, renderCartList, toggleModal, filterItems, filterCat function á€á€½á€±á€€ á€á€„á€ºá€›á€±á€¸á€‘á€¬á€¸á€á€²á€·á€¡á€á€­á€¯á€„á€ºá€¸ á€¡á€€á€¯á€”á€ºá€›á€¾á€­á€”á€±á€•á€«á€á€šá€º) ...

        function updateQty(id, delta) {
            cart[id].qty += delta;
            if(cart[id].qty <= 0) delete cart[id];
            updateCartBar(); renderCartList();
        }

        function manualQty(id, val) {
            let n = parseInt(val);
            if(isNaN(n) || n <= 0) delete cart[id];
            else cart[id].qty = n;
            updateCartBar(); renderCartList();
        }

        function removeItem(id) {
            delete cart[id];
            updateCartBar();
            renderCartList();
        }

        function updateCartBar() {
            const bar = document.getElementById('cart-bar');
            const qty = Object.values(cart).reduce((s, i) => s + i.qty, 0);
            const amt = Object.values(cart).reduce((s, i) => s + (i.qty * i.price), 0);
            if(qty > 0) {
                bar.style.display = 'flex';
                document.getElementById('total-ks').innerText = amt.toLocaleString() + " Ks";
                document.getElementById('total-items').innerText = qty + " Items";
                document.getElementById('modal-total-val').innerText = amt.toLocaleString() + " Ks";
            } else { bar.style.display = 'none'; toggleModal(false); }
        }

        function renderCartList() {
            const container = document.getElementById('cart-items-list');
            let html = "";
            for(let id in cart) {
                const item = cart[id];
                html += `
                <div class="cart-item">
                    <img src="${item.image || 'https://via.placeholder.com/50'}" class="cart-img">
                    <div class="cart-info">
                        <span class="cart-name">${item.name}</span>
                        <span class="cart-price">${(item.qty * item.price).toLocaleString()} Ks</span>
                    </div>
                    <div class="cart-qty-ctrl">
                        <button class="qty-btn" onclick="updateQty('${id}', -1)">-</button>
                        <input type="number" class="qty-input" value="${item.qty}" onchange="manualQty('${id}', this.value)">
                        <button class="qty-btn" onclick="updateQty('${id}', 1)">+</button>
                    </div>
                    <i class="fas fa-trash-alt del-item" onclick="removeItem('${id}')"></i>
                </div>`;
            }
            container.innerHTML = html;
        }

        function toggleModal(show) {
            document.getElementById('cart-modal').style.display = show ? 'flex' : 'none';
            if(show) {
                renderCartList();
                document.getElementById('o-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('o-time').value = new Date().toLocaleTimeString('en-GB',{hour:'2-digit', minute:'2-digit'});
            }
        }

        function filterItems() {
            const val = document.getElementById('search').value.toLowerCase();
            renderMenu(menuData.filter(m => m.name.toLowerCase().includes(val)));
        }

        function filterCat(c, el) {
            document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            renderMenu(c === 'All' ? menuData : menuData.filter(m => m.category === c));
        }

        // sendOrder á€‘á€²á€™á€¾á€¬ deviceUID á€•á€«á€¡á€±á€¬á€„á€º á€•á€¼á€„á€ºá€•á€±á€¸á€‘á€¬á€¸á€•á€«á€á€šá€º (á€¡á€á€…á€º)
        function sendOrder() {
            const user = auth.currentUser;
            if (!user) return alert("Login á€¡á€›á€„á€ºá€á€„á€ºá€•á€«");

            const n = document.getElementById('o-name').value;
            const p = document.getElementById('o-phone').value;
            if(!n || !p) return showToast("á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€”á€¬á€™á€Šá€ºá€”á€¾á€„á€·á€º á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º á€–á€¼á€Šá€·á€ºá€•á€«");
            if(Object.keys(cart).length === 0) return showToast("á€á€¼á€„á€ºá€¸á€á€±á€¬á€„á€ºá€¸á€‘á€²á€™á€¾á€¬ á€•á€…á€¹á€…á€Šá€ºá€¸á€™á€›á€¾á€­á€•á€«");

            const btn = document.getElementById('submit-btn');
            btn.innerText = "á€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€”á€±á€•á€«á€á€Šá€º..."; btn.disabled = true;

            const orderId = "ORD" + Math.floor(1000 + Math.random() * 9000);
            const order = {
                orderId: orderId,
                deviceUID: user.uid, // History á€¡á€á€½á€€á€º á€’á€«á€€ á€¡á€›á€±á€¸á€€á€¼á€®á€¸á€†á€¯á€¶á€¸
                customerName: n, 
                customerPhone: p,
                date: document.getElementById('o-date').value,
                time: document.getElementById('o-time').value,
                note: document.getElementById('o-note').value,
                items: Object.values(cart),
                total: Object.values(cart).reduce((s, i) => s + (i.qty * i.price), 0),
                status: "Pending",
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref('orders').push(order).then(() => {
                localStorage.setItem('myDeviceUID', user.uid); // Track á€”á€²á€· History á€¡á€á€½á€€á€º UID á€á€­á€™á€ºá€¸á€œá€­á€¯á€€á€ºá€á€šá€º
                window.location.href = "order_success.html";
            }).catch(err => {
                showToast("á€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€™á€¾á€¯á€›á€¾á€­á€”á€±á€•á€«á€á€Šá€º");
                btn.innerText = "á€¡á€±á€¬á€ºá€’á€«á€á€„á€ºá€™á€Šá€º"; btn.disabled = false;
            });
        }
        window.onload = init;
    </script>
</body>
</html>
